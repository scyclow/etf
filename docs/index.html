<!--

TODO
  - popup at beginning of site
  - Are you
    - An Individual Investor
    - An Authorized Participant





 -->



<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ETF</title>
  <link rel="shortcut icon" type="image/x-icon" href="./assets/etf.png" id="favicon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="description" content="ETF seeks to simulate the experience of owning shares of an exchange-traded fund that seeks to reflect, before fees and expenses, the performance of the price of Ethereum.">
  <meta name="keywords" content="steviep, steve pikelny, pikelny, crypto, ethereum, etf, bitcoin, erc20, memecoin, shitcoin, exchange-traded fund">

  <meta name="twitter:image" content="https://etf.steviep.xyz/assets/etf.png">
  <meta name="twitter:image:alt" content="ETF">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@steviepxyz">
  <meta name="twitter:site" content="@steviepxyz">
  <meta property="twitter:description" content="ETF seeks to simulate the experience of owning shares of an exchange-traded fund that seeks to reflect, before fees and expenses, the performance of the price of Ethereum.">

  <meta name="og:image" property="og:image" content="https://etf.steviep.xyz/assets/etf.png">
  <meta name="og:image:alt" content="ETF">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://etf.steviep.xyz">
  <meta property="og:title" content="ETF">
  <meta property="og:site_name" content="ETF">
  <meta property="og:description" content="ETF seeks to simulate the experience of owning shares of an exchange-traded fund that seeks to reflect, before fees and expenses, the performance of the price of Ethereum.">


  <link rel="stylesheet" type="text/css" href="./styles.css">

  <style type="text/css">



    #roleModal {
      background: var(--bg-color);
      padding: 2em;
      width: 500px;
      max-width: 80vw;
      border: 3px solid var(--accent-color);
    }

    #roleModal a {
      color: var(--accent-color);
    }
    #roleModal h3 {
      text-align: center;
      margin-bottom: 1em;
    }



    .cta {
      height: 6em;
      display: flex;
      align-items: center;
      justify-content: space-around;
      flex-direction: column;
    }



    .apGrid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      justify-items: center;
    }

    .apItem {
      margin-bottom: 1em;
    }
    .apOwner {
      font-family: monospace;
      color: var(--accent-color);
      text-decoration: underline;
    }
    .apOwner:hover {
      text-decoration: none;

    }

    #timeLeft {
      margin-left: 0.5em;
      font-family: monospace;
      font-size: 1.25em;
    }

    #kycPreview {
      display: flex;
      justify-content: center;
    }
    #kycPreview svg {
      max-width: 500px;
    }

    #kycCard svg {
      max-width: 200px;
    }

    #kycInput {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 1em;
    }
    #kycInput input {
      text-align: center;
    }

    .chartHolder {
      margin-top: 1em;
      display: flex;
      justify-content: space-around;
    }

    .portfolioTable {
      margin-bottom: 2em;
    }


    .portfolioTable td {
      font-family: monospace;
      padding-left: 1em;
      padding-bottom: 0.5em;
      vertical-align: top;
    }

    .portfolioTable td:first-child {
      padding-left: 0em;
    }

    .contractLink {
      color: var(--accent-color);
      text-decoration: underline;
      margin-bottom: 0.5em;
      display: block;
    }

    #brokerDealerSection {
      margin-top: 1em;
    }

    #bridge {
      background: var(--accent-color);
      color: var(--bg-color);
      padding:  2em;
    }

    @media(max-width: 600px) {
      .chartHolder h2 {
        text-align: center;
        margin-top: 0.5em;
      }
      .chartHolder {
        flex-direction: column;
      }
    }


    @media(max-width: 820px) {
      .apGrid {
        grid-template-columns: 1fr 1fr;
      }
    }


    @media(max-width: 540px) {
      .apGrid {
        grid-template-columns: 1fr;
      }

      #kycInput {
        flex-direction: column;
      }
      #kycInput * {
        margin-right: 0;
        margin-bottom: 0.5em;
      }
    }

    @media(max-width: 370px) {
      .address {
        font-size: 0.85em;
      }
    }


  </style>


  <script src="./utils.js"></script>
  <script type="module" src="./modal.js"></script>
  <script type="module" src="./connectWallet.js"></script>




</head>
<body>
  <header>
    <div>
      <h1>ETF</h1>
      <div class="headerPattern">
        <div style="width: 100%"></div>
        <div style="width: 80%"></div>
        <div style="width: 60%"></div>
        <div style="width: 40%"></div>
        <div style="width: 20%"></div>
      </div>

        <!-- <a href="#facts">Terms →</a> -->
      <connect-wallet>
        <div slot="noWeb3" class="cta">
          <a href="#facts">Fund Facts →</a>
          <a href="#ap">Liquidity →</a>
          <a href="#howToBuy">How To Buy →</a>
        </div>

        <div slot="notConnected" class="cta">
          <a href="#facts">Fund Facts →</a>
          <a href="#howToBuy">How To Buy →</a>
          <connect-button>
            <button id="connectButton" slot="button">Connect</button>
            <div slot="loading">Loading...</div>
          </connect-button>
        </div>

        <div slot="connected" class="cta">
          <a href="#facts">Fund Facts →</a>
          <a href="#ap">Liquidity →</a>
          <a href="#howToBuy">How To Buy →</a>
        </div>
      </connect-wallet>

    </div>

    <div style="display: block; text-align: center; margin-top: 1.5em; letter-spacing: 0.3em;">Trading Hours: M-F | 9:30AM-4:00PM (ET) <a href="#timeLord" style="color: var(--accent-color); text-decoration:underline;">*</a></div>


    <connect-wallet style="display: flex; justify-content: center; align-items: center;">
      <div class="marketTimer" slot="connected" style="display: flex; justify-content: center; margin-top: 1em;">
        <div id="marketChange"></div><div id="timeLeft"></div>
      </div>
    </connect-wallet>
  </header>

  <main>
    <section id="facts" style="padding-top: 1em;">
      <section>
        <connect-wallet>
          <div slot="noWeb3">
            <dl>
              <div>
                <dt>Ticker</dt>
                <dd>$ETF</dd>
              </div>

              <div>
                <dt>Net Asset Value (NAV)</dt>
                <dd>0.0001 ETH</dd>
              </div>

              <div>
                <dt>Authorized Participants</dt>
                <dd>6</dd>
              </div>

              <div>
                <dt>Inception Date</dt>
                <dd>04/08/2024</dd>
              </div>
            </dl>

            <dl>
              <div>
                <dt>Benchmark</dt>
                <dd>Ethereum</dd>
              </div>

              <div>
                <dt>Sector</dt>
                <dd>Cryptocurrency</dd>
              </div>

              <div>
                <dt>Gross Expense Ratio</dt>
                <dd>0.00%</dd>
              </div>

              <div>
                <dt>30-Day SEC Yield</dt>
                <dd>0.00%</dd>
              </div>
            </dl>
            <em style="text-align:center; display: block; margin-bottom: 0.25em">Visit this website in a web3-connected browser for more information</em>

          </div>

          <div slot="notConnected">
            <dl>
              <div>
                <dt>Ticker</dt>
                <dd>$ETF</dd>
              </div>

              <div>
                <dt>Net Asset Value (NAV)</dt>
                <dd>0.0001 ETH</dd>
              </div>

              <div>
                <dt>Authorized Participants</dt>
                <dd>6</dd>
              </div>

              <div>
                <dt>Inception Date</dt>
                <dd>04/08/2024</dd>
              </div>
            </dl>

            <dl>
              <div>
                <dt>Benchmark</dt>
                <dd>Ethereum</dd>
              </div>

              <div>
                <dt>Sector</dt>
                <dd>Cryptocurrency</dd>
              </div>

              <div>
                <dt>Gross Expense Ratio</dt>
                <dd>0.00%</dd>
              </div>

              <div>
                <dt>30-Day SEC Yield</dt>
                <dd>0.00%</dd>
              </div>
            </dl>

            <em style="text-align:center; display: block; margin: 1em auto;">Connect wallet for more facts</em>
          </div>

          <div slot="connected">
            <dl>
              <div>
                <dt>Ticker</dt>
                <dd>$ETF</dd>
              </div>

              <div>
                <dt>Net Asset Value (NAV)</dt>
                <dd>0.0001 ETH</dd>
              </div>

              <div>
                <dt>Authorized Participants</dt>
                <dd>6</dd>
              </div>

              <div>
                <dt>Inception Date</dt>
                <dd>04/08/2024</dd>
              </div>
            </dl>

            <dl>
              <div>
                <dt>Premium/Discount (bps)</dt>
                <dd>N/A</dd>
              </div>

              <div>
                <dt>Market Price</dt>
                <dd>N/A</dd>
              </div>

              <div>
                <dt>Shares Outstanding</dt>
                <dd id="sharesOutstanding">0.0000</dd>
              </div>

              <div>
                <dt>Assets Under Management (AUM)</dt>
                <dd id="aum">0.0000</dd>
              </div>
            </dl>

            <dl class="mobile4x4">
              <div>
                <dt>Benchmark</dt>
                <dd>Ethereum</dd>
              </div>

              <div>
                <dt>Sector</dt>
                <dd>Cryptocurrency</dd>
              </div>

              <div>
                <dt>Gross Expense Ratio</dt>
                <dd>0.00%</dd>
              </div>

              <div>
                <dt>30-Day SEC Yield</dt>
                <dd>0.00%</dd>
              </div>
            </dl>
          </div>
        </connect-wallet>
      </section>

      <section>
        <div class="chartHolder">
          <div style="display: inline-block;">
            <h2>Sector Breakdown</h2>
            <div style="width: 200px; margin: 0.75em auto; ">
              <svg viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
                <circle cx="250" cy="250" r="250" fill="var(--accent-color)"></circle>
                <text font-size="30px" x="50%" y="40%" dominant-baseline="middle" text-anchor="middle" fill="var(--bg-color)">Cryptocurrency: 100%</text>
                <line stroke="var(--bg-color)" x1="250" y1="250" x2="500" y2="250"></line>
              </svg>
            </div>
          </div>

          <div style="display: inline-block;">
            <h2>Top 10 Holdings</h2>
            <div style="width: 200px; margin: 0.75em auto;">
              <svg viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
                <circle cx="250" cy="250" r="250" fill="var(--accent-color)"></circle>
                <text font-size="30px" x="50%" y="40%" dominant-baseline="middle" text-anchor="middle" fill="var(--bg-color)">Ether: 100%</text>
                <line stroke="var(--bg-color)" x1="250" y1="250" x2="500" y2="250"></line>
              </svg>
            </div>
          </div>
        </div>

        <div style="margin-top: 2em">
          <h2 style="text-align: center;">Projected NAV Growth of 10,000 ETF</h2>
          <div style="width: 400px; margin: 0.75em auto; max-width: 100%;">
            <svg viewBox="0 0 840 420" xmlns="http://www.w3.org/2000/svg">

              <text font-size="30px" x="800" y="210" dominant-baseline="middle" text-anchor="middle" fill="var(--font-color)">1 ETH</text>
              <text font-size="30px" x="800" y="390" dominant-baseline="middle" text-anchor="middle" fill="var(--font-color)">Time</text>

              <line x1="30" x2="30" y1="10" y2="410" stroke="var(--font-color)" stroke-width="4"></line>
              <line x1="10" x2="750" y1="390" y2="390" stroke="var(--font-color)" stroke-width="4"></line>
              <rect x="32" y="210" width="718" height="178" fill="var(--accent-color)"></rect>

              <line x1="32" x2="750" y1="210" y2="210" stroke="var(--font-color)" stroke-width="2"></line>


            </svg>
          </div>
        </div>
      </section>

      <section style="margin-top: 1em">
        <h3>Overview</h3>
        <p>ETF seeks to simulate the experience of owning shares of an exchange-traded fund that seeks to reflect, before fees and expenses, the performance of the price of Ethereum.</p>

        <p>All shares are standard ERC-20 tokens that may only be traded during market trading hours of Monday through Friday, 9:30am to 4:00pm. Market Holidays and DST can be declared by the Time Lord. Shares of ETF may only be created and redeemed by six Authorized Participants (APs). </p>

        <p>ETF is not an investment company registered under the Investment Company Act of 1940, and therefore is not subject to the same regulatory requirements as mutual funds or ETFs registered under the Investment Company Act of 1940. ETF is not a commodity pool for purposes of the Commodity Exchange Act. Before making an investment decision, you should carefully consider the risk factors associated with owning cryptocurrency, and consult your financial advisor. Past performance does not guarantee future results.</p>
      </section>

    </section>

    <section id="ap">
      <h2>Authorized Participants (APs)</h2>
      <p>Authorized Participants are determined by ownership of six "ETF Authorized Participant NFTs" (henceforth referred to as "APs"). APs have the right (but not the obligation) to create and redeem shares of ETF. At any point, five of the six outstanding APs may vote to revoke the ownership of the remaining AP, which can only be done in the event of a unanimous decision.</p>

      <p>APs may only create shares by delivering a "creation basket" of Ether in the ratio of 1ETH:10000ETF (or 0.0001ETH:1ETF) to the AP smart contract. Similarly, they may only redeem shares by delivering a "redemption basket" of ETF to the AP smart contract in the same ratio. This functions to provide crucial liquidity to the market for ETF. Whenever shares of ETF begin trading at a premium on the secondary market (i.e. above the NAV of 0.0001 ETH per share), APs can provide liquidity by creating and selling new shares. In doing so, they take advantage of an arbitrage opportunity. Alternatively, whenever shares of ETF trade at a discount (i.e. below the NAV of 0.0001 ETH per share), APs can purchase shares on the secondary market and redeem them to take advantage of the same arbitrage opportunity.</p>

      <p>In the event that the Authorized Participants fail to arbitrage the price differential between the ETF market price and NAV, shares of ETF may experience a non-trivial level of tacking error.</p>



      <div class="apGrid" style="margin-top:3em">
        <div id="ap1" class="apItem">
          <a href="./ap/1"><img src="./assets/ap1.svg"></a>
          <connect-wallet>
            <div slot="connected" style="margin-top: 0.5em">
              <div id="ap1-display"></div>
            </div>
          </connect-wallet>
        </div>
        <div id="ap2" class="apItem">
          <a href="./ap/2"><img src="./assets/ap2.svg"></a>
          <connect-wallet>
            <div slot="connected" style="margin-top: 0.5em">
              <div id="ap2-display"></div>
            </div>
          </connect-wallet>
        </div>
        <div id="ap3" class="apItem">
          <a href="./ap/3"><img src="./assets/ap3.svg"></a>
          <connect-wallet>
            <div slot="connected" style="margin-top: 0.5em">
              <div id="ap3-display"></div>
            </div>
          </connect-wallet>
        </div>
        <div id="ap4" class="apItem">
          <a href="./ap/4"><img src="./assets/ap4.svg"></a>
          <connect-wallet>
            <div slot="connected" style="margin-top: 0.5em">
              <div id="ap4-display"></div>
            </div>
          </connect-wallet>
        </div>
        <div id="ap5" class="apItem">
          <a href="./ap/5"><img src="./assets/ap5.svg"></a>
          <connect-wallet>
            <div slot="connected" style="margin-top: 0.5em">
              <div id="ap5-display"></div>
            </div>
          </connect-wallet>
        </div>
        <div id="ap6" class="apItem">
          <a href="./ap/6"><img src="./assets/ap6.svg"></a>
          <connect-wallet>
            <div slot="connected" style="margin-top: 0.5em">
              <div id="ap6-display"></div>
            </div>
          </connect-wallet>
        </div>
      </div>
    </section>

    <section id="timeLord" >
      <h2>Time Lord</h2>
      <p>The Time Lord has the sole ability to declare DST and Market Holidays. DST may be declared at any time without restriction, and may be reversed at any time without restriction. The declaration of DST will move the market open and market close earlier by one hour. Up to 10 Market Holidays may be declared in the 366 day period following the fund's inception. After 365 days, the balance of Market Holidays that may be declared is reset to 10.</p>
      <p>The Time Lord does not have the ability to create or redeem shares. The Time Lord is determined via ownership over the Time Lord NFT, which Authorized Participants cannot revoke.</p>

      <div class="apItem" style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <a href="./timeLord"><img src="./assets/tl.svg" style="width: 300px; max-width: 100%"></a>
        <connect-wallet>
          <div slot="connected" style="margin-top: 1em">
            <div id="tl-display"></div>
          </div>
        </connect-wallet>
      </div>
    </section>

    <section id="portfolio" style="padding-top: 1em;">
      <h2>Your Portfolio</h2>

      <connect-wallet>
        <div slot="connected">
          <section class="connectedAsSection">
            <h3 class="label">CONNECTED AS:</h3>
            <div id="connectedAs1" style="font-family: monospace;"></div>
            <div id="connectedAs2" style="font-family: monospace;"></div>
            <div id="connectedBalance" style="font-family: monospace;"></div>
            <div id="connectedNetwork" style="font-family: monospace;"></div>
          </section>
          <table class="portfolioTable">
            <tbody style="">
              <tr>
                <td>Current ETF Balance:</td> <td id="sharesOwned">--</td>
              </tr>
              <tr>
                <td>Current ETH Balance:</td> <td id="ethBalance">--</td>
              </tr>
              <tr>
                <td>Total Portfolio Value:</td> <td id="portfolioValue">--</td>
              </tr>
            </tbody>
          </table>

          <div id="kyc">
            <div id="kycView">
              <h3 id="kycHeader">KYC Information</h3>
              <table class="portfolioTable">
                <tr>
                  <td>First Name</td>
                  <td id="kycFirstName">Stevendsfsdf</td>
                </tr>

                <tr>
                  <td>Last Name</td>
                  <td id="kycLastName">Pikelnyrkgldfs</td>
                </tr>

                <tr>
                  <td>Address</td>
                  <td id="kycAddr" style="word-break: break-all;">0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266</td>
                </tr>

                <tr>
                  <td>NFT</td>
                  <td id="kycCard"></td>
                </tr>
              </table>
            </div>

            <div id="kycRegister">
              <h3 id="kycHeader">Register KYC Information</h3>

              <div id="kycInput">
                <input id="firstNameInput" class="textInput" placeholder="First Name">
                <input id="lastNameInput" class="textInput" placeholder="Last Name">
                <button id="submitKYC" style="font-size:1em">Submit</button>
              </div>

              <div id="kycLoading" style="padding: 0.5em 1em; text-align: center;"></div>

              <h3 style="text-align: center;text-transform: uppercase; font-size: 0.75em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em">Preview</h3>
              <div id="kycPreview"></div>
            </div>
          </div>
        </div>
      </connect-wallet>

      <div id="howToBuy">
        <!-- uniswap link -->
      </div>


      <connect-wallet>
        <div slot="noWeb3">
          <div style="font-size: 1em;"><em>Visit this site in a web3-connected browser to view your portfolio</em></div>
        </div>

        <div slot="notConnected">
          <em style="display: block; text-align: center; padding: 1em">Connect to view portfolio and buy $ETF</em>
          <connect-button>
            <button id="connectButton" slot="button" style="font-size: 1em">Connect</button>
            <div slot="loading">Loading...</div>
          </connect-button>
        </div>

        <div slot="connected">
           <div id="brokerDealerSection"></div>
        </div>
      </connect-wallet>
    </section>

    <section id="bridge">
      <h3 style="margin-bottom: 1em"><a href="https://secure-etf-bridge.0ms.co/base" target="_blank" style="text-decoration: underline; color: var(--bg-color)">Bridge ETF to Base →</a></h3>
      <em style="color: var(--bg-color);">WARNING: This is an external link, and will take you to a third-party website</em>
    </section>



<!--     <connect-wallet>
      <section slot="connected" id="registerKYC">
        <h2>Register KYC Information</h2>



      </section>
     -->

    <section>
      <h2>View Contracts</h2>
      <h3><a href="https://etherscan" target="_blank" rel="nofollow" class="contractLink">ETF Contract  →</a></h3>
      <h3><a href="https://etherscan" target="_blank" rel="nofollow" class="contractLink">ETF.B Contract  →</a></h3>
      <h3><a href="https://etherscan" target="_blank" rel="nofollow" class="contractLink">Authorized Participant Contract  →</a></h3>
      <h3><a href="https://etherscan" target="_blank" rel="nofollow" class="contractLink">KYC Contract  →</a></h3>
      <h3><a href="https://etherscan" target="_blank" rel="nofollow" class="contractLink">Broker Dealer Contract  →</a></h3>
    </section>
  </main>

  <footer>
    <h4>Risk Disclosure</h4>

    <p>ETF is not an investment company registered under the Investment Company Act of 1940, and therefore is not subject to the same regulatory requirements as mutual funds, ETFs, or other exchange-traded products registered under the Investment Company Act of 1940. Before making a financial decision, you should carefully consider the risk factors associated with owning cryptocurrency, and consult your financial advisor. Past performance does not guarantee future results.</p>

    <p>Furthermore, purchasing shares of ETF does not constitute an investment contract, and shares of ETF do not constitute financial securities. Owners of ETF have no reasonable expectaiton of profit, as Authorized Participants are expected to arbitrage any differences between ETF market price and net asset value (NAV). Additionally, Authorized Participant NFTs do not constitute financial securities, as any profits derived from ownership of said tokens would be due soley to the efforts of the token owner, rather than the entrepreneurial efforts of others.</p>

    <p>All smart contracts developed by Steve Pikelny, including the ETF and Authorized Participant contracts, are provided "as is," without warranty of any kind, express or implied, including but not limited to the warranties of merchantability, fitness for a particular purpose, and non-infringement. The developer makes no warranty that the Software will be error-free, uninterrupted, or free of defects. The developer shall not be responsible for any financial loss incurred by the user as a result of using the Software. This includes but is not limited to losses resulting from investment decisions, trading activities, software bugs, or any other financial transactions conducted using the Software.</p>

    <p>Investing in digital assets, such as Ether and elaborate DeFi-inspired memecoins, involves significant risk due to their extreme price volatility and the potential for loss, theft, or compromised private keys. The value of shares is closely tied to acceptance, industry developments, and governance changes, making them highly susceptible to market sentimant. Digital assets represent a new and rapidly evolving industry, and the value of Shares depends on the acceptance of Ethereum. Changes in the governance of a digital asset network may not receive sufficient support from users or stakers, which may negatively affect that digital asset network's ability to grow and respond to challenges. Investing in ETF comes with risks that could impact ETF's share value, including large-scale sales by major holders, security threats like breaching or hacking, negative sentiment among speculators, and competition from central bank digital currencies and financial initiatives using blockchain technology. A disruption of the internet or a digital asset network, such as the Ethereum network, would affect the ability to transfer digital assets, including Ether and ETF, and would consequently impact their value. There can be no assurance that the smart contracts holding ETF's assets are free of defects, will actually work as designed, or prove to be successful in safeguarding ETFs assets against all possible sources of theft, loss, or damage. Additionally, there is no assurance that the designated Authorized Participants will exercise their right to create and redeem shares of ETF, which may lead to significant tracking error between the secondary market share price and NAV. In some cases, this could lead to significant price volatility.</p>

    <div style="text-align:center; font-size: 2em; font-style: normal; margin: 2em;"><a href="https://steviep.xyz" target="_blank" style="color: var(--accent-color); text-decoration: underline;">steviep.xyz</a> (c) 2024</div>
  </footer>



  <etf-modal id="modal">
    <div slot="content" id="roleModal">
      <h2 style="margin-bottom: 1em; text-align: center;"><em>Confirm your role to continue</em></h2>
        <h3><a onclick="closeModal()" href="#portfolio">Individual Trader</a></h3>
        <h3><a onclick="closeModal()" href="#ap">Liquidity Provider</a></h3>
        <h3><a onclick="closeModal()" href="#timeLord">NFT Collector</a></h3>
  </etf-modal>
</body>


<script src="./contracts.js"></script>
<script src="./auctionMap.js"></script>


<script>
  function closeModal() {
    document.getElementById('modal').close()
    ls.set('chosenRole', true)
  }

</script>
<script type="module">

  import {$} from './$.js'
  import {provider, bnToN, txValue, ethVal, isENS, ZERO_ADDR} from './eth.js'




  setTimeout(() => {
    if (!ls.get('chosenRole')) $.id('modal').open()
  }, 8000)


  if (window.location.hash) {
    setTimeout(() => {
      const h = window.location.hash
      window.location.hash = ''
      window.location.hash = h
    }, 200)
  }


  provider.setContractInfo(CONTRACTS)


  const etherscanAddr = addr => `<a href="https://etherscan.io/address/${addr}" target="_blank" class="address">${addr}</a>`


  let ETF, AP, AUCTION, KYC, BROKER_DEALER
  provider.onConnect(async (addr) => {

    try {
      ({ ETF, AP, AUCTION, KYC, BROKER_DEALER } = await provider.getContracts())

      $.id('aum').innerHTML = fromWei(await provider.getETHBalance(ETF.address)).toFixed(2) + ' ETH'
      $.id('sharesOutstanding').innerHTML = fromWei(await ETF.totalSupply()).toFixed(2)

      times(7, async _i => {
        const i = _i
        try {
          const ownerAddr = await AP.ownerOf(i)

          if (ownerAddr === AUCTION.address) {
            const auctionId = AUCTION_MAP[i]
            const [
              highestBid,
              auction,
              auctionEndTime,
              isActive
            ] = await Promise.all([
              AUCTION.auctionIdToHighestBid(auctionId),
              AUCTION.auctionIdToAuction(auctionId),
              AUCTION.auctionEndTime(auctionId),
              AUCTION.isActive(auctionId),
            ])

            const bidderDisplay = highestBid.bidder === ZERO_ADDR
              ? '-'
              : `<a href="https://etherscan.io/address/${highestBid.bidder}" class="apOwner" target="_blank" rel="nofollow">${await provider.formatAddr(highestBid.bidder)}</a></dd>`

            const bidAdj = isActive ? 'Highest' : 'Winning'

            if (i > 0) {
              $.id(`ap${i}-display`).innerHTML = `
                <div style="display:flex;justify-content:center;margin-bottom:1em"><a class="apOwner" href="./ap/${i}">${isActive ? 'Make Bid' : 'View'} →</a></div>
                <div>
                  <dt>${bidAdj} Bidder</dt>
                  <dd>${bidderDisplay}</dd>
                </div>
                <div>
                  <dt>${bidAdj} Bid</dt>
                  <dd>${fromWei(highestBid.amount)} ETH</dd>
                </div>
                <div>
                  <dt>Time Left</dt>
                  <dd id="ap${i}-timer">-</dd>
                </div>
              `
            } else {

              $.id(`tl-display`).innerHTML = `
                <div style="display:flex;justify-content:center;margin-bottom:1em"><a class="apOwner" href="./timeLord">${isActive ? 'Make Bid' : 'View'} →</a></div>
                <div>
                  <dt>${bidAdj} Bidder</dt>
                  <dd>${bidderDisplay}</dd>
                </div>
                <div>
                  <dt>${bidAdj} Bid</dt>
                  <dd>${fromWei(highestBid.amount)} ETH</dd>
                </div>
                <div>
                  <dt>Time Left</dt>
                  <dd id="ap${i}-timer">-</dd>
                </div>
              `
            }

            if (isActive && bnToN(highestBid.timestamp)) triggerTimer(bnToN(auctionEndTime) * 1000 - Date.now(), $.id(`ap${i}-timer`))

          } else {
            if (i > 0) {
              $.id(`ap${i}-display`).innerHTML = `
                <div style="display:flex;justify-content:center;margin-bottom:1em"><a class="apOwner" href="./ap/${i}">More Info →</a></div>
                <div>
                  <dt>Owned By</dt>
                  <dd><a href="https://etherscan.io/address/${ownerAddr}" class="apOwner" target="_blank" rel="nofollow">${await provider.formatAddr(ownerAddr)}</a></dd>
                </div>
                <div>
                  <dt>Shares Created</dt>
                  <dd>${fromWei(await ETF.created(i)).toFixed(2)}</dd>
                </div>
                <div>
                  <dt>Shares Redeemed</dt>
                  <dd>${fromWei(await ETF.redeemed(i)).toFixed(2)}</dd>
                </div>
              `
            } else {
              const isDST = await ETF.isDST()
              const yearsElapsed = bnToN(await ETF.yearsElapsed())
              const marketHolidaysDeclared = bnToN(await ETF.yearToMarketHolidaysDeclared(yearsElapsed))
              $.id(`tl-display`).innerHTML = `
                <div style="display:flex;justify-content:center;margin-bottom:1em"><a class="apOwner" href="./timeLord">More Info →</a></div>
                <div>
                  <dt>Is DST</dt>
                  <dd>${isDST}</dd>
                </div>
                <div>
                  <dt>Market Holidays Declared (Year ${yearsElapsed})</dt>
                  <dd>${marketHolidaysDeclared}</dd>
                </div>
              `
            }

          }
        } catch (e) {
          console.error(e)
        }
      })


      const [
        ethBalance,
        connectedNetwork,
        formattedAddr,
      ] = await Promise.all([
        provider.getETHBalance(addr),
        provider.getNetwork(),
        provider.formatAddr(addr, provider),
      ])

      if (isENS(formattedAddr)) {
        $.id('connectedAs1').innerHTML = formattedAddr
      }
      $.id('connectedAs2').innerHTML = etherscanAddr(addr)

      let networkName, networkDescriptor
      if (connectedNetwork.name && connectedNetwork.name !== 'unknown') {
        networkName = connectedNetwork.chainId === 1 ? 'mainnet' : connectedNetwork.name
        networkDescriptor = 'Network'
      } else {
        networkName = connectedNetwork.chainId
        networkDescriptor = 'Network ID'
      }

      $.id('connectedNetwork').innerHTML = `${networkDescriptor}: ${networkName}`





      function updateKYCPreview(firstName='', lastName='', address=ZERO_ADDR) {
        $.id('kycPreview').innerHTML = `
          <svg viewBox="0 0 380 250" xmlns="http://www.w3.org/2000/svg">
            <style>.k{dominant-baseline:middle;text-anchor:middle;font-size:40px;font-family:serif}.n{fill:#e74d61;font-family:monospace;font-size:30px}.a{fill:#e74d61;font-family:monospace;font-size:11px}</style>
            <rect x="0" y="0" width="380" height="250" fill="#f1f1d1" stroke="#002150"></rect>
            <rect x="10" y="10" width="360" height="230" stroke="#002150" fill="none" rx="15"></rect>
            <rect x="15" y="15" width="350" height="220" stroke="#002150" fill="none" rx="15"></rect>
            <rect x="15" y="15" width="350" height="50" fill="#4368a2" rx="15" stroke="#002150"></rect>
            <rect x="15.5" y="50" width="349" height="15" fill="#4368a2" ></rect>
            <line x1="15" y1="65" x2="365" y2="65" stroke="#002150"></line>
            <text x="192" y="47" class="k" fill="#082262">KYC</text>
            <text x="191" y="46" class="k" fill="#082262">KYC</text>
            <text x="190" y="45" class="k" fill="#fbf7ed" stroke="#002150">KYC</text>
            <text class="n k" x="50%" y="119">${firstName}</text>
            <text class="n k" x="50%" y="156">${lastName}</text>
            <text class="a k" x="50%" y="210">${address}</text>
          </svg>
        `
      }


      async function renderKYCSection() {
        const $kycView = $.id('kycView')
        const $kycRegister = $.id('kycRegister')
        const $firstNameInput = $.id('firstNameInput')
        const $lastNameInput = $.id('lastNameInput')
        const $kycLoading = $.id('kycLoading')

        const existingKYCTokenId = await KYC.addrToTokenId(addr)

        if (bnToN(existingKYCTokenId) === 0) {
          hide($kycView)
          unhide($kycRegister)
          updateKYCPreview('', '', addr)
          $firstNameInput.onkeyup = () => updateKYCPreview($firstNameInput.value, $lastNameInput.value, addr)
          $lastNameInput.onkeyup = () => updateKYCPreview($firstNameInput.value, $lastNameInput.value, addr)

          $.id('submitKYC').onclick = async () => {
            console.log('111')
            if (!$firstNameInput.value || !$lastNameInput.value) {
              $kycLoading.innerHTML = 'Please enter your first and last name.'
            }
            $kycLoading.innerHTML = ''
            console.log('222')

            try {
              const tx = await KYC.register($firstNameInput.value, $lastNameInput.value,)
            console.log('333')
              $kycLoading.innerHTML = `TX Pending. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="nofollow" style="color: var(--accent-color)">View on etherscan</a>`
              const txReciept1 = await tx.wait(1)
            console.log('444')
              renderKYCSection()
            } catch (e) {
              $kycLoading.innerHTML = e?.data?.message || e?.error?.message || e?.message || 'Something went wrong'
              console.error(e)
            }
          }
        } else {
          unhide($kycView)
          hide($kycRegister)

          const $kycFirstName = $.id('kycFirstName')
          const $kycLastName = $.id('kycLastName')
          const $kycAddr = $.id('kycAddr')
          const $kycCard = $.id('kycCard')

          const utf8Clean = raw => raw.replace(/data.*utf8,/, '')
          const b64Clean = raw => raw.replace(/data.*,/, '')
          const b64Decode = raw => atob(b64Clean(raw))
          const getSVG = rawURI => b64Decode(JSON.parse(utf8Clean(rawURI)).image)

          const kycInfo = await KYC.kycInfo(await KYC.addrToTokenId(addr))


          $kycCard.innerHTML = getSVG(await KYC.tokenURI(existingKYCTokenId))
          $kycFirstName.innerHTML = kycInfo.firstName
          $kycLastName.innerHTML = kycInfo.lastName
          $kycAddr.innerHTML = kycInfo.addr
        }
      }

      await renderKYCSection()


      const stakedAPTokenId = bnToN(await BROKER_DEALER.stakedTokenId())
      const stakedAddr = await BROKER_DEALER.stakedAddr()
      const sharesOwned = ethVal(await ETF.balanceOf(addr))

      const $sharesOwned = $.id('sharesOwned')
      const $ethBalance = $.id('ethBalance')
      const $portfolioValue = $.id('portfolioValue')
      const $kyc = $.id('kyc')

      $sharesOwned.innerHTML = sharesOwned.toFixed(2) + ' Shares'
      $ethBalance.innerHTML = fromWei(ethBalance).toFixed(2) + ' ETH'
      $portfolioValue.innerHTML = (fromWei(ethBalance) + sharesOwned/10000).toFixed(2) + ' ETH'



      if (stakedAPTokenId !== 0) {
        const createEnabled = await BROKER_DEALER.createEnabled()
        const redeemEnabled = await BROKER_DEALER.redeemEnabled()

        let bdDescription = `Authorized Participant ${stakedAPTokenId} has staked their AP token in the BrokerDealer contract`

        if (createEnabled) {
          bdDescription += `, allowing traders with <a href="#kyc" style="color:var(--accent-color)">registered KYC information</a> to purchase up to 10,000 shares at NAV (0.0001 ETH).`
        }

        if (createEnabled && !redeemEnabled) {
          bdDescription += ` To purchase more shares from the Broker Dealer, please contact ${etherscanAddr(await provider.formatAddr(stakedAddr, false))}.`
        }
        if (createEnabled && redeemEnabled) {
          bdDescription += ` Additionally, KYC-registered traders may redeem up to 10,000 shares at NAV (0.0001 ETH). To buy or sell more shares with the Broker Dealer, please contact ${etherscanAddr(await provider.formatAddr(stakedAddr, false))}.`
        }
        if (!createEnabled && redeemEnabled) {
          bdDescription += `, allowing traders with <a href="#kyc" style="color:var(--accent-color)">registered KYC information</a> to redeem up to 10,000 shares at NAV (0.0001 ETH). To redeem more shares with the Broker Dealer, please contact ${etherscanAddr(await provider.formatAddr(stakedAddr, false))}.`
        }
        if (!createEnabled && !redeemEnabled) {
          bdDescription += '.'
        }

        $.id('brokerDealerSection').innerHTML = `
          <div style="border: 3px solid; padding: 1em; margin-top: 3em">
            <h3>Broker Dealer [Authorized Participant ${stakedAPTokenId}] <img src="./assets/ap${stakedAPTokenId}.svg" style="width:25px; transform:translateY(0.4em); padding-left:0.25em"></h3>
            <p>${bdDescription}</p>

            <div id="createSharesBD">
              <h4 style="margin-bottom:0.25em">Buy Shares (0.0001 ETH per share)</h4>
              <input id="createETF" class="textInput" placeholder="Shares" type="number" style="margin-bottom:0.5em">
              <button id="createETFSubmit" style="font-size:1em">Submit</button>
              <div id="creationPreview" style="padding:0.5em; margin-bottom:0.5em"></div>
            </div>

            <div id="redeemSharesBD">
              <div>
                <h4 style="margin-bottom:0.25em">Sell Shares (0.0001 ETH per share)</h4>

                <input id="redeemETF" class="textInput" placeholder="Shares" type="number" style="margin-bottom:0.5em">
                <button id="redeemETFSubmit" style="font-size:1em">Submit</button>
                <div id="redemptionPreview" style="padding:0.5em; margin-bottom:0.5em"></div>
              </div>
              <div>
                <h4>Approve Shares for Broker Dealer Redemption</h4>
                <input id="approveBD" class="textInput" placeholder="Shares" type="number" style="margin-bottom:0.5em">
                <button id="approveBDSubmit" style="font-size:1em">Approve Broker Dealer</button>
                <div id="bdApprovePreview" style="padding:0.5em; margin-bottom:0.5em"></div>
              </div>
            </div>
          </div>
        `


        const $creationPreview = $.id('creationPreview')
        const $redemptionPreview = $.id('redemptionPreview')
        const $createETF = $.id('createETF')
        const $redeemETF = $.id('redeemETF')
        const $createETFSubmit = $.id('createETFSubmit')
        const $redeemETFSubmit = $.id('redeemETFSubmit')
        const $approveBDSubmit = $.id('approveBDSubmit')
        const $bdApprovePreview = $.id('bdApprovePreview')

        const $createSharesBD = $.id('createSharesBD')
        const $redeemSharesBD = $.id('redeemSharesBD')


        console.log(redeemEnabled, createEnabled)

        if (!redeemEnabled) hide($redeemSharesBD)
        if (!createEnabled) hide($createSharesBD)


        $createETF.onkeyup = (e) => {
          $creationPreview.innerHTML = `(${e.target.value / 10000} ETH)`
        }

        $redeemETF.onkeyup = (e) => {
          if (e.target.value > sharesOwned) {
            $redemptionPreview.innerHTML = `<span style="color: red">You do not own this many shares</span>`
          } else {
            $redemptionPreview.innerHTML = ``
          }
        }



        $createETFSubmit.onclick = async () => {
          const kycInfo = await KYC.kycInfo(await KYC.addrToTokenId(addr))

          try {
            const kycId = bnToN(await KYC.addrToTokenId(addr))
            if (kycId === 0) {
              $creationPreview.innerHTML = `Invalid KYC information. Please <a href="#registerKYC" style="color:var(--accent-color)">register KYC information above</a>`
              return
            }

            const tx = await BROKER_DEALER.create(kycInfo.firstName, kycInfo.lastName, txValue($createETF.value/10000))

            $creationPreview.innerHTML = `TX Pending. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="nofollow" style="color: var(--accent-color)">View on etherscan</a>`

            const txReciept1 = await tx.wait(1)

            $creationPreview.innerHTML = 'Success!'
            const sharesOwned = fromWei(await ETF.balanceOf(await provider.signer.getAddress()))
            $sharesOwned.innerHTML = sharesOwned.toFixed(2)
            $createETF.value = ''

          } catch (e) {
            $creationPreview.innerHTML = e?.data?.message || e?.error?.message || e?.message || 'Something went wrong'

            console.error(e)
          }
        }

        $redeemETFSubmit.onclick = async () => {
          const kycInfo = await KYC.kycInfo(await KYC.addrToTokenId(addr))



          try {
            const kycId = bnToN(await KYC.addrToTokenId(addr))
            if (kycId === 0) {
              $redemptionPreview.innerHTML = `Invalid KYC information. Please <a href="#registerKYC" style="color:var(--accent-color)">register KYC information above</a>`
              return
            }
            const tx = await BROKER_DEALER.redeem(kycInfo.firstName, kycInfo.lastName, toETH($redeemETF.value))

            $redemptionPreview.innerHTML = `TX Pending. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="nofollow" style="color: var(--accent-color)">View on etherscan</a>`

            const txReciept1 = await tx.wait(1)

            $redemptionPreview.innerHTML = 'Success!'
            const sharesOwned = fromWei(await ETF.balanceOf(await provider.signer.getAddress()))
            $sharesOwned.innerHTML = sharesOwned.toFixed(2)
            $redeemETF.value = ''
            $.id('ethBalance').innerHTML = await provider.getETHBalance(addr)

          } catch (e) {
            $redemptionPreview.innerHTML = e?.data?.message || e?.error?.message || e?.message || 'Something went wrong'
            console.error(e)
          }
        }


        $approveBDSubmit.onclick = async () => {
          try {
            const tx = await ETF.approve(BROKER_DEALER.address, toETH($.id('approveBD').value))

            $bdApprovePreview.innerHTML = `TX Pending. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="nofollow" style="color: var(--accent-color)">View on etherscan</a>`

            const txReciept1 = await tx.wait(1)

            $bdApprovePreview.innerHTML = 'Success!'

            $.id('approveBD').value = ''
            $.id('ethBalance').innerHTML = await provider.getETHBalance(addr)

          } catch (e) {
            $bdApprovePreview.innerHTML = e?.data?.message || e?.error?.message || e?.message || 'Something went wrong'
            console.error(e)
          }
        }
      }


    } catch (e) {
      console.error(e)
    }


  })








  const $timeLeft = $.id('timeLeft')
  const $marketChange = $.id('marketChange')

  function getNextTimestamp(isDST=false, isMarketHoliday=false) {
    const currentTimestamp = Date.now();
    const currentDate = new Date(currentTimestamp);
    const currentDay = currentDate.getUTCDay();
    const currentHour = currentDate.getUTCHours();
    const currentMinutes = currentDate.getUTCMinutes();

    // Check if it's Sunday, Monday, Tuesday, Wednesday, or Thursday after 9:00 PM UTC
    if (currentDay >= 0 && currentDay <= 4 && (currentHour >= 21 || isMarketHoliday)) {
      // Return UTC timestamp for 2 PM the next day
      const nextDayTimestamp = currentTimestamp + (24 * 60 * 60 * 1000); // Add 1 day
      const nextDay = new Date(nextDayTimestamp);
      nextDay.setUTCHours(14, 30, 0, 0); // Set time to 2:30 PM UTC
      return nextDay.getTime();
    }

    // Check if it's Friday after 9:00 PM UTC, Saturday, or Sunday
    if (
      (currentDay === 5 && (currentHour >= 21 || isMarketHoliday))
      || currentDay === 6 || currentDay === 0)
    {
      // Return UTC timestamp for the coming Monday at 1:30 PM
      const nextMondayTimestamp = currentTimestamp + ((8 - currentDay) % 7) * 24 * 60 * 60 * 1000; // Add days until Monday
      const nextMonday = new Date(nextMondayTimestamp);
      nextMonday.setUTCHours(14, 30, 0, 0); // Set time to 2:30 PM UTC
      return nextMonday.getTime();
    }


    // It's M-F before 2:30PM UTC
    if (currentDay > 0 && currentDay < 6 && (currentHour < 14 || (currentHour === 14 && currentMinutes < 30))) {
      currentDate.setUTCHours(14, 30, 0, 0);
      return currentDate.getTime();
    }

    // Market is open
    currentDate.setUTCHours(21, 0, 0, 0);
    return currentDate.getTime();
  }


  function isMarketOpen() {
    const currentTimestamp = Date.now();
    const currentDate = new Date(currentTimestamp);
    const currentDay = currentDate.getUTCDay();
    const currentHour = currentDate.getUTCHours();
    const currentMinutes = currentDate.getUTCMinutes();

    return currentDay > 0 && currentDay < 6 && (currentHour > 14 || currentHour === 14 && currentMinutes >= 30) && currentHour < 21
  }


  function setRunInterval(fn, ms, i=0) {
    const run = () => {
      fn(i)
      i++
    }

    run()

    let isCleared = false

    let interval = setInterval(run, ms)

    const newInterval = (ms) => {
      if (isCleared) return
      clearInterval(interval)
      interval = setInterval(run, ms)
    }

    const stopInterval = () => {
      if (!isCleared) {
        clearInterval(interval)
        isCleared = true
      }
    }
    return stopInterval
  }



  function triggerTimer(timeLeft, $elem1, cb) {
    const with0 = x => x < 10 ? '0' + Math.floor(x) : Math.floor(x)
    let timeLeftCounter = timeLeft
    return setRunInterval(() => {
      timeLeftCounter = Math.max(timeLeftCounter - 1000, 0)
      const days = timeLeftCounter / (24*60*60*1000)
      const hours = 24 * (days%1)
      const minutes = 60 * (hours%1)
      const seconds = Math.floor(60 * (minutes%1))


      $elem1.innerHTML = `${Math.floor(days)}:${with0(hours)}:${with0(minutes)}:${with0(seconds)}`

      if (timeLeftCounter <= 0) {
        timeLeftCounter = getNextTimestamp() - Date.now()
      }

      if (cb) cb()

    }, 1000)
  }

  console.log(getNextTimestamp(), Date.now(), getNextTimestamp() - Date.now())

  triggerTimer(getNextTimestamp() - Date.now(), $timeLeft, () => {
    if (isMarketOpen()) {
       $marketChange.innerHTML = 'Market Closes in:'
    } else {
       $marketChange.innerHTML = 'Market Opens in:'
    }
  })

  function unhide(element) {
    $(element, 'display', '')
  }

  function hide(element) {
    $(element, 'display', 'none')
  }


</script>
</html>